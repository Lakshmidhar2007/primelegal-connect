/**
 * @fileoverview Firestore Security Rules for PRIMELEGAL CONNECT.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for personal data
 * while allowing public read access to lawyer profiles. All write operations
 * are protected by authentication checks and ownership validation.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user account information. Accessible only
 *   to the user themselves.
 * - /lawyer_profiles/{lawyerId}: Stores public lawyer profile information.
 *   Publicly readable, but only the lawyer can modify their own profile.
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Public lawyer profiles are stored in a separate collection from private
 *   user data to enable efficient public listing while maintaining security.
 * - Data required for authorization is denormalized directly onto documents
 *   being secured to avoid costly `get()` calls in the rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user account information.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own user document if the userId matches their auth.uid.
     * @allow (get, list, update, delete) - Authenticated user can only access their own user document.
     * @deny (create) - If the userId does not match the authenticated user's uid.
     * @deny (get, list, update, delete) - If the user is not authenticated or is trying to access another user's document.
     * @principle Enforces strict user-ownership for private account data.
     */
    match /users/{userId} {
      // Check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the user ID matches the authenticated user's UID
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
        allow update: if isSignedIn() && isOwner(userId) && resource.data.id == userId;
        allow delete: if isSignedIn() && isOwner(userId) && resource.data.id == userId;
    }

    /**
     * @description Controls access to public lawyer profile information.
     * @path /lawyer_profiles/{lawyerId}
     * @allow (get, list) - Anyone can read lawyer profiles.
     * @allow (create, update, delete) - Only the lawyer can create, update, or delete their own profile.
     * @deny (create, update, delete) - If the user is not authenticated or is trying to access another lawyer's profile.
     * @principle Allows public read access for lawyer profiles while enforcing ownership for modifications.
     */
    match /lawyer_profiles/{lawyerId} {
      // Check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Check if the lawyer ID matches the authenticated user's UID
      function isOwner(lawyerId) {
        return request.auth.uid == lawyerId;
      }

        allow get, list: if true;
        allow create: if isSignedIn() && isOwner(lawyerId) && request.resource.data.userId == lawyerId;
        allow update: if isSignedIn() && isOwner(lawyerId) && resource.data.userId == lawyerId;
        allow delete: if isSignedIn() && isOwner(lawyerId) && resource.data.userId == lawyerId;
    }

    /**
     * @description Denies listing appointments
     * @path /appointments
     * @allow (get) - No conditions, not relevant to the error.
     * @allow (list) - Listing is disallowed.
     * @allow (create, update, delete) - No conditions, access is false.
     * @deny (list) - All `list` operations are forbidden.
     * @principle Prevent listing of appointments.
     */
    match /appointments {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}