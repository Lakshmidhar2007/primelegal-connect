/**
 * @fileoverview Firestore Security Rules for PRIMELEGAL CONNECT application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user accounts and lawyer profiles,
 * with public read access to lawyer profiles.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user account information. Only the user can read/write their own data.
 * - /lawyer_profiles/{lawyerId}: Stores public lawyer profiles. Publicly readable, but only lawyers can create/update their own profile.
 *
 * Key Security Decisions:
 * - User accounts are private and only accessible to the owning user.
 * - Public lawyer profiles are publicly readable to support displaying a list of lawyers.
 * - All write operations require authentication.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user accounts. Only the user can read/write their own data.
     * @path /users/{userId}
     * @allow (create, update, delete, get) if the user is signed in and their UID matches the userId.
     * @deny (create, update, delete, get) if the user is not signed in, or their UID does not match the userId.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure public lawyer profiles. Publicly readable, but only lawyers can create/update their own profile.
     * @path /lawyer_profiles/{lawyerId}
     * @allow (get, list) any user, authenticated or not, can read lawyer profiles.
     * @allow (create, update, delete) only the lawyer whose UID matches the lawyerId can create/update/delete their profile.
     * @deny (create, update, delete) if the user is not signed in, or their UID does not match the lawyerId.
     * @principle Enforces document ownership for writes, allows public reads.
     */
    match /lawyer_profiles/{lawyerId} {
      function isLawyer(lawyerId) {
        return request.auth != null && request.auth.uid == lawyerId;
      }

      function isExistingLawyer(lawyerId) {
        return isLawyer(lawyerId) && resource != null;
      }

      allow get, list: if true;

      allow create: if isLawyer(lawyerId);
      allow update: if isExistingLawyer(lawyerId);
      allow delete: if isExistingLawyer(lawyerId);
    }

     /**
      * @description Allows any signed-in user to list cases.
      * @path /cases
      * @allow (list) if the user is signed in.
      * @deny (list) if the user is not signed in.
      * @principle Allows any signed-in user to list cases.
      */
     match /cases/{caseId} {
          function isSignedIn() {
              return request.auth != null;
          }

          allow get: if isSignedIn();
          allow list: if isSignedIn();

          allow create: if false;
          allow update: if false;
          allow delete: if false;
      }
  }
}