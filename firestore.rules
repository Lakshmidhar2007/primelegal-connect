/**
 * @fileoverview Firestore Security Rules for the PRIMELEGAL CONNECT application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for private data, while allowing public read access to lawyer profiles.
 *
 * Data Structure:
 * - /users/{userId}: Stores sensitive user account information. Only the user can read/write.
 * - /lawyer_profiles/{lawyerId}: Stores public lawyer profiles. Publicly readable, but only the lawyer can edit.
 * - /users/{userId}/cases: Cases are stored as an array inside the user document
 *
 * Key Security Decisions:
 * - User listing is implicitly denied by the data model.
 * - Public lawyer profiles are explicitly separated from private user data.
 * - No data shape validation is performed in this prototyping phase.
 *
 * Denormalization for Authorization:
 * - The lawyer_profiles collection uses the lawyerId as the document ID to simplify ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user account documents.
     * @path /users/{userId}
     * @allow (create) User with UID 'mkigfR3969RLt7MimPYoqeEp2nv1' can create their own document at /users/mkigfR3969RLt7MimPYoqeEp2nv1.
     * @deny (create) User with UID 'differentUserId' cannot create a document at /users/mkigfR3969RLt7MimPYoqeEp2nv1.
     * @allow (get, list) User with UID 'mkigfR3969RLt7MimPYoqeEp2nv1' can read their own document at /users/mkigfR3969RLt7MimPYoqeEp2nv1.
     * @deny (get, list) User with UID 'differentUserId' cannot read the document at /users/mkigfR3969RLt7MimPYoqeEp2nv1.
     * @allow (update) User with UID 'mkigfR3969RLt7MimPYoqeEp2nv1' can update their own document at /users/mkigfR3969RLt7MimPYoqeEp2nv1.
     * @deny (update) User with UID 'differentUserId' cannot update the document at /users/mkigfR3969RLt7MimPYoqeEp2nv1.
     * @allow (delete) User with UID 'mkigfR3969RLt7MimPYoqeEp2nv1' can delete their own document at /users/mkigfR3969RLt7MimPYoqeEp2nv1.
     * @deny (delete) User with UID 'differentUserId' cannot delete the document at /users/mkigfR3969RLt7MimPYoqeEp2nv1.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted

      // Allow self-creation: User can create their own document.
      allow create: if isOwner(userId) ;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }


    /**
     * @description Controls access to public lawyer profile documents.
     * @path /lawyer_profiles/{lawyerId}
     * @allow (get, list) Any user can read lawyer profiles.
     * @deny (create) User with UID 'differentUserId' cannot create a profile for lawyerId 'lawyer123'.
     * @allow (create) User with UID 'lawyer123' can create their profile.
     * @allow (update) User with UID 'lawyer123' can update their profile at /lawyer_profiles/lawyer123.
     * @deny (update) User with UID 'differentUserId' cannot update the profile at /lawyer_profiles/lawyer123.
     * @allow (delete) User with UID 'lawyer123' can delete their own profile at /lawyer_profiles/lawyer123.
     * @deny (delete) User with UID 'differentUserId' cannot delete the profile at /lawyer_profiles/lawyer123.
     * @principle Public read access, owner-only writes.
     */
    match /lawyer_profiles/{lawyerId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == lawyerId;
      allow update: if isExistingOwner(lawyerId);
      allow delete: if isExistingOwner(lawyerId);
    }


    /**
     * @description Controls access to cases associated with a specific user. Cases are stored as a subcollection of the user document.
     * @path /users/{userId}/cases
     * @allow (list) User with UID 'mkigfR3969RLt7MimPYoqeEp2nv1' can list their cases.
     * @deny (get) User with UID 'mkigfR3969RLt7MimPYoqeEp2nv1' cannot get a single case document directly (not a separate collection).
     * @deny (create) Cases are nested inside the user document and cannot be created directly as separate documents.
     * @deny (update) Cases are nested inside the user document and cannot be updated directly as separate documents.
     * @deny (delete) Cases are nested inside the user document and cannot be deleted directly as separate documents.
     * @principle Enforces ownership for listing cases. Get, create, update, delete operations are disabled because cases are an array inside user document.
     */
    match /users/{userId}/cases {
      allow get: if false;
      allow list: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }

  // Helper Functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}