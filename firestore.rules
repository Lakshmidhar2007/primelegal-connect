/**
 * @fileOverview Firestore Security Rules for PRIMELEGAL CONNECT.
 *
 * Core Philosophy:
 * This ruleset prioritizes user data privacy and enforces strict ownership.
 * Users can only read and write their own data, while public lawyer profiles
 * are readable by anyone.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user account information.
 * - /lawyer_profiles/{lawyerId}: Stores public lawyer profiles.
 *
 * Key Security Decisions:
 * - User accounts are secured with path-based ownership.
 * - Public lawyer profiles are readable by everyone, but only writable by the profile owner.
 * - Cases are stored in a user doc and cannot be accessed directly as a subcollection.
 * - Denormalization: Lawyer profile documents store userId, firstName, lastName, photoURL, specialty, bio, website, and linkedin for simpler read rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     * @returns {boolean} True if the request is authenticated, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the UID matches, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner and the resource exists.
     * @param {string} userId The user ID to compare against the authenticated user's UID.
     * @returns {boolean} True if the UID matches and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * @description Rules for user account documents.
     * @path /users/{userId}
     * @allow (create) User 'Dx2RT7SMBqMVxOkNbmpgrDply1E3' can create their own account document.
     * @deny (create) User 'OtherUserId' cannot create a document for user 'Dx2RT7SMBqMVxOkNbmpgrDply1E3'.
     * @allow (get) User 'Dx2RT7SMBqMVxOkNbmpgrDply1E3' can get their own account document.
     * @deny (get) User 'OtherUserId' cannot get the account document for user 'Dx2RT7SMBqMVxOkNbmpgrDply1E3'.
     * @allow (update) User 'Dx2RT7SMBqMVxOkNbmpgrDply1E3' can update their own account document.
     * @deny (update) User 'OtherUserId' cannot update the account document for user 'Dx2RT7SMBqMVxOkNbmpgrDply1E3'.
     * @allow (delete) User 'Dx2RT7SMBqMVxOkNbmpgrDply1E3' can delete their own account document.
     * @deny (delete) User 'OtherUserId' cannot delete the account document for user 'Dx2RT7SMBqMVxOkNbmpgrDply1E3'.
     * @deny (list) Listing user documents is not allowed.
     * @principle Enforces document ownership and prevents unauthorized access to user data.
     */
    match /users/{userId} {
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
      allow list: if false;
    }

    /**
     * @description Rules for public lawyer profile documents.
     * @path /lawyer_profiles/{lawyerId}
     * @allow (create) User 'LawyerUID' can create their own lawyer profile.
     * @deny (create) User 'OtherUID' cannot create lawyer profile for 'LawyerUID'.
     * @allow (get) Any user can get a lawyer profile.
     * @allow (list) Any user can list lawyer profiles.
     * @allow (update) User 'LawyerUID' can update their own lawyer profile.
     * @deny (update) User 'OtherUID' cannot update lawyer profile for 'LawyerUID'.
     * @allow (delete) User 'LawyerUID' can delete their own lawyer profile.
     * @deny (delete) User 'OtherUID' cannot delete lawyer profile for 'LawyerUID'.
     * @principle Allows public read access to lawyer profiles while enforcing ownership for writes.
     */
    match /lawyer_profiles/{lawyerId} {
      allow create: if isOwner(lawyerId) && request.resource.data.userId == lawyerId;
      allow get, list: if true;
      allow update: if isExistingOwner(lawyerId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(lawyerId);
    }

     /**
      * @description Cases are stored in a user doc and cannot be accessed directly as a subcollection.
      * @path /cases
      * @deny (list) No direct listing of cases. Cases are embedded in UserAccount documents
      * @principle Cases are embedded and protected by UserAccount ownership rules.
      */
    match /cases {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
    }
  }
}