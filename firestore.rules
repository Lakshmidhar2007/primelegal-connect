/**
 * @fileoverview Firestore Security Rules for PRIMELEGAL CONNECT application.
 *
 * Core Philosophy:
 * This ruleset implements a hybrid security model: strict user-ownership for private data
 * (e.g., user accounts) and public read access with owner-only writes for public lawyer profiles.
 * It leverages Firebase Authentication to verify user identity and enforce access control.
 *
 * Data Structure:
 * - /users/{userId}: Stores sensitive user account information. Access is restricted to the owning user.
 * - /lawyer_profiles/{lawyerId}: Stores public profile data for lawyers. Publicly readable, but only the lawyer can modify their profile.
 *
 * Key Security Decisions:
 * - User listing is disabled.
 * - Public lawyer profiles are separated from private user accounts for secure public listing.
 * - Strict ownership is enforced on all write operations.
 *
 * Denormalization for Authorization:
 * The `PublicLawyerProfile` includes a `userId` field that MUST match the document ID (`lawyerId`).
 * This denormalization is critical for enforcing owner-only write access to the profile.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to a user's document only to themselves.
     * @path /users/{userId}
     * @allow (create) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can create /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @allow (get) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can get /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @allow (update) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can update /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @allow (delete) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can delete /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @deny (create) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 cannot create /users/anotherUserId.
     * @deny (get) User anotherUserId cannot get /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @principle Enforces document ownership for all operations on user accounts.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to lawyer profiles, but restricts write access to the profile owner.
     * @path /lawyer_profiles/{lawyerId}
     * @allow (get) Any user (or no user) can read /lawyer_profiles/lawyer123.
     * @allow (list) Any user (or no user) can list /lawyer_profiles.
     * @allow (create) User lawyer123 can create /lawyer_profiles/lawyer123 if lawyerId matches their UID.
     * @allow (update) User lawyer123 can update /lawyer_profiles/lawyer123 if lawyerId matches their UID.
     * @allow (delete) User lawyer123 can delete /lawyer_profiles/lawyer123 if lawyerId matches their UID.
     * @deny (create) User anotherUser cannot create /lawyer_profiles/lawyer123.
     * @deny (update) User anotherUser cannot update /lawyer_profiles/lawyer123.
     * @deny (delete) User anotherUser cannot delete /lawyer_profiles/lawyer123.
     * @principle Allows public read access while enforcing owner-only write access.
     */
    match /lawyer_profiles/{lawyerId} {
      allow get, list: if true;
      allow create: if isLawyerOwner(lawyerId) && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingLawyerOwner(lawyerId) && request.resource.data.userId == lawyerId;
      allow delete: if isExistingLawyerOwner(lawyerId);
    }

    /**
     * @description Access denied to /appointments collection.
     * @path /appointments
     * @allow (get) nobody can access /appointments
     * @allow (list) nobody can access /appointments
     * @allow (create) nobody can access /appointments
     * @allow (update) nobody can access /appointments
     * @allow (delete) nobody can access /appointments
     */
     match /appointments {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isLawyerOwner(lawyerId) {
          return isSignedIn() && request.auth.uid == lawyerId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isExistingLawyerOwner(lawyerId) {
      return isLawyerOwner(lawyerId) && resource != null;
    }
  }
}