rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Users can only read and write to their own user document.
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Lawyer profiles are publically readable, but only the lawyer can write their own profile.
    match /lawyer_profiles/{lawyerId} {
      allow get;
      allow list;
      allow write: if request.auth.uid == lawyerId;
    }
    
    // A lawyer can query for their own appointments that are available.
    match /appointments/{appointmentId} {
      allow read, write: if request.auth.uid == resource.data.lawyerId;
      allow list: if request.auth.uid == request.query.where.lawyerId && request.query.where.status == 'Available';
    }

    // Chat documents can only be read or written to by participants.
    match /chats/{chatId} {
      allow read, write: if request.auth.uid in resource.data.participants;
      // Allow a user to list chats they are a part of.
      allow list: if request.auth.uid in request.query.where.participants;
    }

    // Messages can only be read or written by chat participants.
    match /chats/{chatId}/messages/{messageId} {
       allow read, write: if request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
    }
  }
}
    