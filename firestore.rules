/**
 * @file Firebase Security Rules for PRIMELEGAL CONNECT
 *
 * @core_philosophy This ruleset enforces a user-ownership model for private data,
 * allowing users to read and write their own information. Public lawyer profiles
 * are readable by anyone but writable only by the profile owner.
 *
 * @data_structure
 * - /users/{userId}: Stores private user account data.
 * - /lawyer_profiles/{lawyerId}: Stores public lawyer profiles.
 *
 * @key_security_decisions
 * - Users can only read and write their own user documents.
 * - Public lawyer profiles are publicly readable but only writable by the profile owner.
 * - Listing of users is not allowed.
 * - Assumes `lawyerId` in `/lawyer_profiles/{lawyerId}` is the same as the user's UID.
 *
 * @denormalization_for_authorization
 * - The `lawyer_profiles` collection uses the `userId` field to verify ownership,
 * avoiding the need for complex queries.
 *
 * @structural_segregation
 * - Public and private lawyer data is stored in separate collections
 * (`users` and `lawyer_profiles`) to optimize read access and security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user account information.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their own document.
     * @allow (get) User with UID 'user123' can read their own document.
     * @allow (update) User with UID 'user123' can update their own document.
     * @allow (delete) User with UID 'user123' can delete their own document.
     * @deny (create) User with UID 'user456' cannot create a document for 'user123'.
     * @deny (get) User with UID 'user456' cannot read the document of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Validate that the authenticated user is the owner of the resource
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Validate that the authenticated user is the owner of the resource and the resource exists
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure public lawyer profiles.
     * @path /lawyer_profiles/{lawyerId}
     * @allow (get) Any user can read lawyer profiles.
     * @allow (list) Any user can list lawyer profiles.
     * @allow (create) Lawyer with UID 'lawyer123' can create their own profile.
     * @allow (update) Lawyer with UID 'lawyer123' can update their own profile.
     * @allow (delete) Lawyer with UID 'lawyer123' can delete their own profile.
     * @deny (create) User with UID 'user456' cannot create a profile for 'lawyer123'.
     * @deny (update) User with UID 'user456' cannot update the profile of 'lawyer123'.
     * @principle Allows public reads but restricts writes to the profile owner.
     */
    match /lawyer_profiles/{lawyerId} {
      // Validate that the authenticated user is the owner of the resource
      function isOwner(lawyerId) {
        return request.auth.uid == lawyerId;
      }

      // Validate that the authenticated user is the owner of the resource and the resource exists
      function isExistingOwner(lawyerId) {
        return isOwner(lawyerId) && resource != null;
      }

      allow get, list: if true;
      allow create: if isOwner(lawyerId) && request.resource.data.userId == lawyerId;
      allow update: if isExistingOwner(lawyerId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(lawyerId);
    }

      /**
       * @description Prevents unauthorized listing of appointments.
       * @path /appointments
       * @allow (get) Not applicable.
       * @allow (list) No one can list appointments
       * @allow (create) Not applicable.
       * @allow (update) Not applicable.
       * @allow (delete) Not applicable.
       * @deny (list) Any user, even if authenticated, cannot list appointments.
       * @principle Secure by default: listing is denied without specific authorization.
       */
      match /appointments {
        allow get: if false;
        allow list: if false;
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }
  }
}