/**
 * @file Firebase Security Rules for Pr√≠meLegal Connect
 * @version 2
 *
 * @description
 * Core Philosophy:
 * This ruleset enforces a user-ownership model for private user data and a public read, owner-write model for lawyer profiles.
 *
 * Data Structure:
 * - /users/{userId}: Stores private user account data, accessible only to the user themselves.
 * - /lawyer_profiles/{lawyerId}: Stores public lawyer profile data, readable by anyone but writable only by the owning lawyer.
 * - Cases are stored as an array inside the user document, which is not ideal for rules, but acceptable for this prototyping phase.
 *
 * Key Security Decisions:
 * - User listing is implicitly denied by the structure.
 * - Public read access is granted only to the `lawyer_profiles` collection.
 * - Missing data validation to allow for rapid prototyping.
 *
 * Denormalization for Authorization:
 * - Lawyer profiles use the `lawyerId` as the document ID, which must match the `userId` inside the document, and `request.auth.uid` of the user creating/modifying the document. This simplifies ownership checks.
 *
 * Structural Segregation:
 * - Lawyer profiles are stored in a separate `lawyer_profiles` collection to allow public read access without exposing private user data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user account documents.
     * @path /users/{userId}
     * @allow (create) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can create their own document at /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @deny (create) User Abcdefg can't create a document at /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @allow (get, list) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can read their own document at /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @deny (get, list) User Abcdefg cannot read user Dx2RT7SMBqMVxOkNbmpgrDply1E3's document at /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @allow (update, delete) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can update/delete their own document at /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @deny (update, delete) User Abcdefg cannot update/delete user Dx2RT7SMBqMVxOkNbmpgrDply1E3's document at /users/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get, list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to public lawyer profile documents.
     * @path /lawyer_profiles/{lawyerId}
     * @allow (get, list) Anyone can read lawyer profiles.
     * @allow (create) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can create their own profile at /lawyer_profiles/Dx2RT7SMBqMVxOkNbmpgrDply1E3 if userId matches.
     * @deny (create) User Abcdefg can't create a profile at /lawyer_profiles/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @allow (update, delete) User Dx2RT7SMBqMVxOkNbmpgrDply1E3 can update/delete their own profile at /lawyer_profiles/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @deny (update, delete) User Abcdefg cannot update/delete user Dx2RT7SMBqMVxOkNbmpgrDply1E3's profile at /lawyer_profiles/Dx2RT7SMBqMVxOkNbmpgrDply1E3.
     * @principle Allows public reads but enforces ownership for writes.
     */
    match /lawyer_profiles/{lawyerId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.auth.uid == lawyerId && request.resource.data.userId == lawyerId;
      allow update: if isExistingOwnerLawyerProfiles(lawyerId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwnerLawyerProfiles(lawyerId);
    }

        /**
     * @description Cases are stored inside the User document as an array, this is not ideal.
     * @path /cases
     * @allow (list) Any signed in user can list cases.
     * @allow (get, create, update, delete) No access.
     * @principle Allows public reads but enforces ownership for writes.
     */
        match /cases/{caseId} {
            allow list: if isSignedIn();
            allow get, create, update, delete: if false;
        }


    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isOwnerLawyerProfiles(lawyerId) {
      return isSignedIn() && request.auth.uid == lawyerId;
    }

    function isExistingOwnerLawyerProfiles(lawyerId) {
      return isOwnerLawyerProfiles(lawyerId) && resource != null;
    }

  }
}